name: ðŸš€ CI - Loto Tracker API (Maven + Docker Integration)

on:
  push:
  pull_request:

jobs:
  build:
    name: ðŸ— Maven Build + Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ›  Checkout
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup JDK 21
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: 21
          cache: maven

      - name: ðŸ“¦ Build (skip tests)
        run: mvn -B clean install -DskipTests

      - name: ðŸ§ª Unit Tests
        run: mvn -B test -Dtest='*Test' -Dsurefire.failIfNoSpecifiedTests=false

  integration:
    name: ðŸ³ Docker Compose Integration Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: ðŸ›  Checkout
        uses: actions/checkout@v4

      - name: ðŸ§° Install tools (curl + jq)
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      # IMPORTANT: on ne dÃ©marre PAS le frontend en CI (inutile + plus lent)
      - name: ðŸ³ Start Docker Compose (postgres + mongodb + backend)
        run: docker compose up -d --build postgres mongodb backend

      - name: âœ… Wait for Postgres
        run: |
          for i in {1..60}; do
            if docker compose exec -T postgres pg_isready -U postgres -d lotodb > /dev/null 2>&1; then
              echo "âœ… Postgres ready"
              exit 0
            fi
            echo "Waiting postgres..."
            sleep 2
          done
          echo "âŒ Postgres not ready"
          docker compose logs --no-color postgres
          exit 1

      - name: â³ Wait for API
        run: |
          for i in {1..60}; do
            if curl --silent --fail http://localhost:8082/api/hello > /dev/null; then
              echo "âœ… API ready"
              exit 0
            fi
            echo "Waiting API..."
            sleep 5
          done
          echo "âŒ API not ready"
          docker compose ps
          docker compose logs --no-color backend
          exit 1

      # âœ… Fix du problÃ¨me "relation public.users does not exist"
      # On attend explicitement que les migrations/DDL aient crÃ©Ã© la table.
      - name: ðŸ—ƒï¸ Wait for users table
        run: |
          for i in {1..60}; do
            if docker compose exec -T postgres psql -U postgres -d lotodb -tAc \
              "SELECT to_regclass('public.users');" | grep -q "users"; then
              echo "âœ… users table exists"
              docker compose exec -T postgres psql -U postgres -d lotodb -c \
                "SELECT id,email,is_admin FROM public.users LIMIT 5;" || true
              exit 0
            fi
            echo "Waiting schema/migrations..."
            sleep 2
          done
          echo "âŒ users table never created"
          docker compose logs --no-color backend
          docker compose exec -T postgres psql -U postgres -d lotodb -c "\dt" || true
          exit 1

      # âœ… Tests API (on crÃ©e un user CI, puis login, puis on utilise le JWT)
      - name: ðŸ‘¤ Register (idempotent)
        run: |
          curl -s -o register.json -w "\nHTTP=%{http_code}\n" \
            -X POST "http://localhost:8082/api/auth/register" \
            -H "Content-Type: application/json" \
            -d '{
              "email":"ci-user@loto.local",
              "password":"StrongPass123!",
              "firstName":"CI",
              "lastName":"Runner"
            }' || true
          cat register.json | jq . || cat register.json || true

      - name: ðŸ”‘ Login & extract JWT
        run: |
          curl -s -o login.json -w "\nHTTP=%{http_code}\n" \
            -X POST "http://localhost:8082/api/auth/login3" \
            -H "Content-Type: application/json" \
            -d '{"email":"ci-user@loto.local","password":"StrongPass123!"}'
          cat login.json | jq . || true

          JWT_TOKEN=$(jq -r '.token // empty' login.json)
          if [ -z "$JWT_TOKEN" ]; then
            echo "âŒ No token returned by login"
            exit 1
          fi
          echo "JWT_TOKEN=$JWT_TOKEN" >> "$GITHUB_ENV"


      - name: ðŸŽ« Create Ticket (JWT)
        run: |
          curl -s -o ticket.json -w "\nHTTP=%{http_code}\n" \
            -X POST "http://localhost:8082/api/tickets" \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -H "Authorization: Bearer $JWT_TOKEN" \
            -d '{"numbers":[1,2,3,4,5],"luckyNumber":6,"drawDate":"2025-03-12"}'
          cat ticket.json | jq . || true

      - name: ðŸ“œ Last 20 Results
        run: |
          curl -s -o last20.json -w "\nHTTP=%{http_code}\n" \
            -X GET "http://localhost:8082/api/historique/last20"
          cat last20.json | jq . || true

      - name: ðŸ§¾ Logs (only if failure)
        if: failure()
        run: |
          docker compose ps
          docker compose logs --no-color postgres
          docker compose logs --no-color mongodb
          docker compose logs --no-color backend

      - name: ðŸ›‘ Stop containers
        if: always()
        run: docker compose down -v
